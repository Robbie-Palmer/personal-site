[tasks.install]
description = "Install all dependencies"
run = "pnpm install"
sources = ["package.json", "pnpm-lock.yaml"]
outputs = ["node_modules"]

[tasks.dev]
description = "Start Next.js development server"
depends = ["//ui:install"]
run = "pnpm dev"

[tasks.build]
description = "Build Next.js application for production"
depends = ["//ui:install", "//ui:images:copy-to-public"]
run = "pnpm build"
sources = ["app/**/*", "components/**/*", "lib/**/*", "public/**/*", "*.ts", "*.tsx", "*.json"]
outputs = ["out/**/*"]

[tasks.test]
description = "Run all tests"
depends = ["//ui:install"]
run = "pnpm test"

[tasks."test:watch"]
description = "Run tests in watch mode"
depends = ["//ui:install"]
run = "pnpm test:watch"

[tasks.lint]
description = "Lint and format check with Biome"
depends = ["//ui:install"]
run = "pnpm lint"

[tasks.format]
description = "Format and fix issues with Biome"
depends = ["//ui:install"]
run = "pnpm format"

[tasks."format:check"]
description = "Check formatting without making changes"
depends = ["//ui:install"]
run = "pnpm format:check"

[tasks.typegen]
description = "Generate Next.js types (PageProps, etc.)"
depends = ["//ui:install"]
run = "pnpm exec next typegen"

[tasks.typecheck]
description = "Run TypeScript type checking"
depends = ["//ui:typegen"]
run = "pnpm typecheck"

[tasks.clean]
description = "Clean build artifacts and dependencies"
run = """
rm -rf .next
rm -rf node_modules
rm -rf out
"""

[tasks.check]
description = "Run all checks (lint, format, typecheck, test)"
depends = ["//ui:lint", "//ui:format:check", "//ui:typecheck", "//ui:test"]

# Image management tasks
[tasks."images:copy-to-public"]
description = "Copy source images to public for deployments"
run = """
#!/usr/bin/env bash
set -e

echo "ğŸ“‹ Copying source images to public/blog-images..."

# Ensure target directory exists
mkdir -p public/blog-images

# Copy all images from source-images/blog to public/blog-images
# This ensures preview deployments have images even without CF Images configured
if [ -d "source-images/blog" ]; then
  cp -r source-images/blog/* public/blog-images/

  # Generate manifest mapping image IDs to file extensions
  # This helps the fallback logic find the right file
  echo "{" > lib/image-manifest.json
  first=true
  for file in source-images/blog/*; do
    if [ -f "$file" ]; then
      filename=$(basename "$file")
      id="${filename%.*}"
      ext="${filename##*.}"

      if [ "$first" = true ]; then
        first=false
      else
        echo "," >> lib/image-manifest.json
      fi

      echo -n "  \"blog/$id\": \"$ext\"" >> lib/image-manifest.json
    fi
  done
  echo "" >> lib/image-manifest.json
  echo "}" >> lib/image-manifest.json

  echo "âœ… Images copied to public/blog-images/"
  echo "âœ… Generated lib/image-manifest.json"
else
  echo "âš ï¸  No source-images/blog directory found"
  # Create empty manifest
  echo "{}" > lib/image-manifest.json
fi
"""

[tasks."images:sync"]
description = "Upload source images to Cloudflare Images"
run = """
#!/usr/bin/env bash
set -e

# Validate required environment variables
if [ -z "$CF_ACCOUNT_ID" ]; then
  echo "âŒ CF_ACCOUNT_ID environment variable is required"
  exit 1
fi

if [ -z "$CF_API_TOKEN" ]; then
  echo "âŒ CF_API_TOKEN environment variable is required"
  exit 1
fi

# Check if running in force update mode (CI/GitHub Actions should set this)
FORCE_UPDATE="${FORCE_UPDATE:-false}"

if [ "$FORCE_UPDATE" = "true" ]; then
  echo "ğŸš€ Starting image sync to Cloudflare Images (FORCE UPDATE MODE)..."
  echo "   Existing images will be updated"
else
  echo "ğŸš€ Starting image sync to Cloudflare Images..."
  echo "   Existing images will be skipped (set FORCE_UPDATE=true to update)"
fi

# Counter for tracking
uploaded=0
updated=0
skipped=0
failed=0

# Find all images in source-images directory
find source-images -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.webp" \) | while read -r filepath; do
  # Get relative path from source-images directory
  relative_path="${filepath#source-images/}"

  # Remove file extension to create image ID
  # e.g., "blog/example.jpg" -> "blog/example"
  image_id="${relative_path%.*}"

  echo ""
  echo "ğŸ“¸ Processing: $filepath"
  echo "   Image ID: $image_id"

  # Upload to Cloudflare Images
  response=$(curl -s -w "\n%{http_code}" -X POST \
    "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/images/v1" \
    -H "Authorization: Bearer ${CF_API_TOKEN}" \
    -F "file=@${filepath}" \
    -F "id=${image_id}")

  http_code=$(echo "$response" | tail -n1)
  body=$(echo "$response" | sed '$d')

  if [ "$http_code" = "200" ]; then
    echo "   âœ… Successfully uploaded"
    uploaded=$((uploaded + 1))
  elif [ "$http_code" = "409" ]; then
    # Image already exists
    if [ "$FORCE_UPDATE" = "true" ]; then
      echo "   ğŸ”„ Image exists, updating..."

      # Delete existing image
      delete_response=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
        "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/images/v1/${image_id}" \
        -H "Authorization: Bearer ${CF_API_TOKEN}")

      if [ "$delete_response" = "200" ]; then
        # Re-upload
        upload_response=$(curl -s -w "\n%{http_code}" -X POST \
          "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/images/v1" \
          -H "Authorization: Bearer ${CF_API_TOKEN}" \
          -F "file=@${filepath}" \
          -F "id=${image_id}")

        upload_http_code=$(echo "$upload_response" | tail -n1)
        if [ "$upload_http_code" = "200" ]; then
          echo "   âœ… Successfully updated"
          updated=$((updated + 1))
        else
          echo "   âŒ Failed to re-upload after delete"
          failed=$((failed + 1))
        fi
      else
        echo "   âŒ Failed to delete existing image"
        failed=$((failed + 1))
      fi
    else
      echo "   â­ï¸  Skipped (already exists)"
      skipped=$((skipped + 1))
    fi
  else
    echo "   âŒ Failed to upload (HTTP $http_code)"
    echo "   Response: $body"
    failed=$((failed + 1))
  fi
done

echo ""
echo "ğŸ“Š Summary:"
echo "   âœ… Uploaded: $uploaded"
if [ "$FORCE_UPDATE" = "true" ]; then
  echo "   ğŸ”„ Updated: $updated"
fi
echo "   â­ï¸  Skipped: $skipped"
echo "   âŒ Failed: $failed"

if [ $failed -gt 0 ]; then
  echo ""
  echo "âš ï¸  Some images failed to upload. Check the logs above."
  exit 1
fi

echo ""
echo "ğŸ‰ Image sync completed successfully!"
"""

[tasks."images:verify-variants"]
description = "Check configured Cloudflare Images variants"
run = """
#!/usr/bin/env bash
set -e

# Validate required environment variables
if [ -z "$CF_ACCOUNT_ID" ]; then
  echo "âŒ CF_ACCOUNT_ID environment variable is required"
  exit 1
fi

if [ -z "$CF_API_TOKEN" ]; then
  echo "âŒ CF_API_TOKEN environment variable is required"
  exit 1
fi

echo "ğŸ” Checking Cloudflare Images variants..."

response=$(curl -s -X GET \
  "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/images/v1/variants" \
  -H "Authorization: Bearer ${CF_API_TOKEN}")

echo "$response" | jq -r '.result.variants[] | "\(.id): \(.options.width)w"' || echo "No variants configured yet"

echo ""
echo "â„¹ï¸  Expected variants:"
echo "   - public: Flexible (accepts URL parameters)"
echo "   - thumbnail: 600w (blog list cards)"
echo "   - hero: 1200w (blog post hero and OpenGraph)"
echo ""
echo "Configure variants in Cloudflare Dashboard:"
echo "https://dash.cloudflare.com/${CF_ACCOUNT_ID}/images/variants"
"""

[tasks."images:health-check"]
description = "Test Cloudflare Images integration end-to-end"
run = """
#!/usr/bin/env bash
set -e

echo "ğŸ¥ Running Cloudflare Images health check..."
echo ""

# Check 1: Environment variables
echo "1ï¸âƒ£  Checking environment configuration..."
if [ -n "$NEXT_PUBLIC_CF_IMAGES_ACCOUNT_HASH" ]; then
  echo "   âœ… NEXT_PUBLIC_CF_IMAGES_ACCOUNT_HASH is set"
else
  echo "   âš ï¸  NEXT_PUBLIC_CF_IMAGES_ACCOUNT_HASH not set (will use local fallback)"
fi

if [ -n "$CF_ACCOUNT_ID" ]; then
  echo "   âœ… CF_ACCOUNT_ID is set"
else
  echo "   âŒ CF_ACCOUNT_ID not set (required for API operations)"
fi

if [ -n "$CF_API_TOKEN" ]; then
  echo "   âœ… CF_API_TOKEN is set"
else
  echo "   âŒ CF_API_TOKEN not set (required for API operations)"
fi
echo ""

# Check 2: Verify API connectivity (if credentials available)
if [ -n "$CF_ACCOUNT_ID" ] && [ -n "$CF_API_TOKEN" ]; then
  echo "2ï¸âƒ£  Testing API connectivity..."
  response=$(curl -s -w "\n%{http_code}" -X GET \
    "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/images/v1" \
    -H "Authorization: Bearer ${CF_API_TOKEN}" \
    --max-time 10)

  http_code=$(echo "$response" | tail -n1)
  if [ "$http_code" = "200" ]; then
    echo "   âœ… API connection successful"

    # Count images
    body=$(echo "$response" | sed '$d')
    image_count=$(echo "$body" | jq -r '.result.images | length' 2>/dev/null || echo "0")
    echo "   ğŸ“Š Total images in account: $image_count"
  else
    echo "   âŒ API connection failed (HTTP $http_code)"
  fi
  echo ""
else
  echo "2ï¸âƒ£  Skipping API connectivity test (credentials not set)"
  echo ""
fi

# Check 3: Test a sample image exists (if source images available)
if [ -d "source-images/blog" ]; then
  echo "3ï¸âƒ£  Checking source images..."
  image_count=$(find source-images/blog -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | wc -l)
  echo "   ğŸ“Š Source images found: $image_count"

  # Pick first image as test subject
  first_image=$(find source-images/blog -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | head -1)
  if [ -n "$first_image" ]; then
    filename=$(basename "$first_image")
    image_id="blog/${filename%.*}"
    echo "   ğŸ§ª Test image: $image_id"

    # Check if exists in CF Images
    if [ -n "$CF_ACCOUNT_ID" ] && [ -n "$CF_API_TOKEN" ]; then
      check_response=$(curl -s -o /dev/null -w "%{http_code}" -X GET \
        "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/images/v1/${image_id}" \
        -H "Authorization: Bearer ${CF_API_TOKEN}" \
        --max-time 10)

      if [ "$check_response" = "200" ]; then
        echo "   âœ… Test image exists in Cloudflare Images"

        # Generate test URL
        if [ -n "$NEXT_PUBLIC_CF_IMAGES_ACCOUNT_HASH" ]; then
          test_url="https://imagedelivery.net/${NEXT_PUBLIC_CF_IMAGES_ACCOUNT_HASH}/${image_id}/hero"
          echo "   ğŸŒ Test URL: $test_url"
          echo "   ğŸ’¡ Open this URL in browser to verify image loads"
        fi
      else
        echo "   âš ï¸  Test image not found in CF Images (run 'mise run //ui:images:sync' first)"
      fi
    fi
  fi
  echo ""
else
  echo "3ï¸âƒ£  No source images found"
  echo ""
fi

# Check 4: Verify variants configured
if [ -n "$CF_ACCOUNT_ID" ] && [ -n "$CF_API_TOKEN" ]; then
  echo "4ï¸âƒ£  Checking image variants..."
  response=$(curl -s -X GET \
    "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/images/v1/variants" \
    -H "Authorization: Bearer ${CF_API_TOKEN}" \
    --max-time 10)

  variants=$(echo "$response" | jq -r '.result.variants[].id' 2>/dev/null || echo "")

  if echo "$variants" | grep -q "thumbnail"; then
    echo "   âœ… thumbnail variant configured"
  else
    echo "   âŒ thumbnail variant missing"
  fi

  if echo "$variants" | grep -q "hero"; then
    echo "   âœ… hero variant configured"
  else
    echo "   âŒ hero variant missing"
  fi
  echo ""
else
  echo "4ï¸âƒ£  Skipping variant check (credentials not set)"
  echo ""
fi

echo "ğŸ Health check complete!"
"""
