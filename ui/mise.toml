[env]
VALID_IMAGE_EXTENSIONS = "jpg|jpeg|png|gif|webp"

[tasks.install]
description = "Install all dependencies"
run = "pnpm install"
sources = ["package.json", "pnpm-lock.yaml"]
outputs = ["node_modules"]

[tasks.dev]
description = "Start Next.js development server"
depends = ["//ui:install"]
run = "pnpm dev"

[tasks.build]
description = "Build Next.js application for production"
depends = ["//ui:install"]
run = "pnpm build"
sources = ["app/**/*", "components/**/*", "lib/**/*", "public/**/*", "*.ts", "*.tsx", "*.json"]
outputs = ["out/**/*"]

[tasks.test]
description = "Run all tests"
depends = ["//ui:install"]
run = "pnpm test"

[tasks."test:watch"]
description = "Run tests in watch mode"
depends = ["//ui:install"]
run = "pnpm test:watch"

[tasks.lint]
description = "Lint and format check with Biome"
depends = ["//ui:install"]
run = "pnpm lint"

[tasks.format]
description = "Format and fix issues with Biome"
depends = ["//ui:install"]
run = "pnpm format"

[tasks."format:check"]
description = "Check formatting without making changes"
depends = ["//ui:install"]
run = "pnpm format:check"

[tasks.typegen]
description = "Generate Next.js types (PageProps, etc.)"
depends = ["//ui:install"]
run = "pnpm exec next typegen"

[tasks.typecheck]
description = "Run TypeScript type checking"
depends = ["//ui:typegen"]
run = "pnpm typecheck"

[tasks.clean]
description = "Clean build artifacts and dependencies"
run = """
rm -rf .next
rm -rf node_modules
rm -rf out
"""

[tasks.check]
description = "Run all checks (lint, format, typecheck, test)"
depends = ["//ui:lint", "//ui:format:check", "//ui:typecheck", "//ui:test"]

# Image management tasks
[tasks."images:sync"]
description = "Upload versioned images to Cloudflare Images with CalVer validation"
depends = ["//ui:install"]
run = "pnpm images:sync"

[tasks."images:health-check"]
description = "Validate Cloudflare Images configuration and connectivity"
depends = ["//ui:install"]
run = "pnpm images:health-check"

# Lighthouse performance testing tasks
[tasks.lighthouse]
description = "Run Lighthouse against running dev server (start dev server first)"
depends = ["//ui:install"]
run = "pnpm lighthouse"

[tasks."lighthouse:serve"]
description = "Build, serve static export, and run Lighthouse tests (desktop + mobile)"
depends = ["//ui:build"]
run = """
#!/usr/bin/env bash
set -e

echo "Starting static server on port 3000..."
pnpm exec serve out -l 3000 &
SERVER_PID=$!
sleep 2

pnpm lighthouse || EXIT_CODE=$?
kill $SERVER_PID 2>/dev/null || true
exit ${EXIT_CODE:-0}
"""
