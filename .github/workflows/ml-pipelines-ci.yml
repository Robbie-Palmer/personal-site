name: ML Pipelines CI

on:
  pull_request:
    paths:
      - "ml-pipelines/**"
      - ".github/workflows/ml-pipelines-ci.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  dvc-pull:
    runs-on: ubuntu-latest
    environment:
      name: cloudflare-production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      GH_TOKEN: ${{ github.token }}
    strategy:
      matrix:
        pipeline:
          - recipe-parsing
    defaults:
      run:
        working-directory: ml-pipelines/${{ matrix.pipeline }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install DVC
        run: pip install 'dvc[s3]'

      - name: Validate DVC remote
        run: dvc pull

      - name: Comment metrics on PR
        run: |
          DIFF=$(dvc metrics diff --md origin/main 2>/dev/null || true)
          DATA_ROWS=$(echo "$DIFF" | grep -c '^|' || true)
          if [ "$DATA_ROWS" -gt 2 ]; then
            BODY="## ${{ matrix.pipeline }} metrics diff"$'\n\n'"$DIFF"
          else
            SHOW=$(dvc metrics show --md 2>/dev/null || echo "No metrics available.")
            BODY="## ${{ matrix.pipeline }} metrics"$'\n\n'"$SHOW"
          fi
          gh pr comment "${{ github.event.pull_request.number }}" --body "$BODY" --edit-last \
            || gh pr comment "${{ github.event.pull_request.number }}" --body "$BODY"
