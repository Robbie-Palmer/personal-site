experimental_monorepo_root = true

[settings]
color = true
verbose = false

[tools]
node = "lts"
pnpm = "latest"
terraform = "latest"

[env]
_.file = ".env"
MISE_EXPERIMENTAL = "1"

# Root-level tasks for repo-wide tooling
[tasks.lint]
description = "Lint all files across the entire repo"
depends = ["//:lint:markdown", "//:lint:mdx", "//:lint:yaml", "//ui:lint", "//infra/cloudflare:lint"]

[tasks."lint:markdown"]
description = "Lint and fix Markdown files (optionally pass files as args)"
run = """
#!/usr/bin/env bash
if [ $# -eq 0 ]; then
  pnpm exec markdownlint --fix "**/*.md" --ignore node_modules --ignore '**/node_modules' --ignore .terraform --ignore '**/.terraform'
else
  pnpm exec markdownlint --fix --ignore node_modules --ignore '**/node_modules' --ignore .terraform --ignore '**/.terraform' "$@"
fi
"""

[tasks."lint:markdown:check"]
description = "Check Markdown files without fixing (optionally pass files as args)"
run = """
#!/usr/bin/env bash
if [ $# -eq 0 ]; then
  pnpm exec markdownlint "**/*.md" --ignore node_modules --ignore '**/node_modules' --ignore .terraform --ignore '**/.terraform'
else
  pnpm exec markdownlint --ignore node_modules --ignore '**/node_modules' --ignore .terraform --ignore '**/.terraform' "$@"
fi
"""

[tasks."lint:mdx"]
description = "Lint and fix MDX files (optionally pass files as args)"
run = """
#!/usr/bin/env bash
if [ $# -eq 0 ]; then
  pnpm exec remark "**/*.mdx" --output --frail --quiet
else
  pnpm exec remark "$@" --output --frail --quiet
fi
"""

[tasks."lint:mdx:check"]
description = "Check MDX files without fixing (optionally pass files as args)"
run = """
#!/usr/bin/env bash
if [ $# -eq 0 ]; then
  pnpm exec remark "**/*.mdx" --frail --quiet
else
  pnpm exec remark "$@" --frail --quiet
fi
"""

[tasks."lint:yaml"]
description = "Lint YAML files (optionally pass files as args)"
run = """
#!/usr/bin/env bash
if [ $# -eq 0 ]; then
  pnpm exec yamllint "**/*.{yml,yaml}" --ignore '**/node_modules/**'
else
  pnpm exec yamllint --ignore '**/node_modules/**' "$@"
fi
"""

[tasks.pre-commit]
description = "Run pre-commit checks (called by Husky)"
run = "pnpm lint-staged"
depends = ["//:install"]

[tasks.install]
description = "Install all dependencies (root and workspaces)"
run = "pnpm install"

# CCPM tasks
[tasks."ccpm:prd:new"]
description = "Validate and setup new PRD"
run = """
#!/usr/bin/env bash
set -e

FEATURE_NAME="${1:-}"

# Validate feature name provided
if [ -z "$FEATURE_NAME" ]; then
  echo "❌ Feature name required. Usage: mise run ccpm:prd:new <feature-name>"
  exit 1
fi

# Validate kebab-case format
if ! [[ "$FEATURE_NAME" =~ ^[a-z][a-z0-9-]*$ ]]; then
  echo "❌ Feature name must be kebab-case (lowercase letters, numbers, hyphens only)"
  echo "   Examples: user-auth, payment-v2, notification-system"
  exit 1
fi

# Check for existing PRD
if [ -f ".claude/prds/$FEATURE_NAME.md" ]; then
  read -p "⚠️  PRD '$FEATURE_NAME' already exists. Overwrite? (yes/no): " response
  if [ "$response" != "yes" ]; then
    echo "Use a different name or run: /pm:prd-parse $FEATURE_NAME"
    exit 1
  fi
fi

# Create directory if needed
mkdir -p .claude/prds

# Copy template with placeholders
cp .claude/ccpm/templates/prd-template.md ".claude/prds/$FEATURE_NAME.md"

# Replace placeholders with actual values
CREATED_DATETIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
sed -i "s/FEATURE_NAME/$FEATURE_NAME/g" ".claude/prds/$FEATURE_NAME.md"
sed -i "s/CREATED_DATETIME/$CREATED_DATETIME/g" ".claude/prds/$FEATURE_NAME.md"

echo "✅ Template created at .claude/prds/$FEATURE_NAME.md"
echo "   Now fill in all sections with comprehensive content"
"""

[tasks."ccpm:prd:parse"]
description = "Validate and setup epic from PRD"
run = """
#!/usr/bin/env bash
set -e

FEATURE_NAME="${1:-}"

# Validate feature name provided
if [ -z "$FEATURE_NAME" ]; then
  echo "❌ Feature name required. Usage: mise run ccpm:prd:parse <feature-name>"
  exit 1
fi

# Verify PRD exists
if [ ! -f ".claude/prds/$FEATURE_NAME.md" ]; then
  echo "❌ PRD not found: $FEATURE_NAME"
  echo "   First create it with: /pm:prd-new $FEATURE_NAME"
  exit 1
fi

# Validate PRD frontmatter
if ! grep -q "^---" ".claude/prds/$FEATURE_NAME.md"; then
  echo "❌ Invalid PRD frontmatter in .claude/prds/$FEATURE_NAME.md"
  echo "   Missing frontmatter delimiters"
  exit 1
fi

# Check required frontmatter fields
for field in name description status created; do
  if ! grep -q "^$field:" ".claude/prds/$FEATURE_NAME.md"; then
    echo "❌ Invalid PRD frontmatter: missing '$field' field"
    exit 1
  fi
done

# Check for existing epic
if [ -f ".claude/epics/$FEATURE_NAME/epic.md" ]; then
  read -p "⚠️  Epic '$FEATURE_NAME' already exists. Overwrite? (yes/no): " response
  if [ "$response" != "yes" ]; then
    echo "View existing epic with: cat .claude/epics/$FEATURE_NAME/epic.md"
    exit 1
  fi
fi

# Create epic directory
mkdir -p ".claude/epics/$FEATURE_NAME"

# Copy template with placeholders
cp .claude/ccpm/templates/epic-template.md ".claude/epics/$FEATURE_NAME/epic.md"

# Replace placeholders with actual values
CREATED_DATETIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
sed -i "s/FEATURE_NAME/$FEATURE_NAME/g" ".claude/epics/$FEATURE_NAME/epic.md"
sed -i "s/CREATED_DATETIME/$CREATED_DATETIME/g" ".claude/epics/$FEATURE_NAME/epic.md"

echo "✅ Template created at .claude/epics/$FEATURE_NAME/epic.md"
echo "   Now analyze PRD and fill in all technical sections"
"""
